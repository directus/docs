---
title: Testing
description: How to run unit and blackbox tests in the Directus codebase.
---

Directus has two main methods of testing, being through unit and blackbox tests.  Unit tests are located in each package and can be run from the pacakage itself. Blackbox tests on the other hand are located in `tests/blackbox`.

## Running tests

### Unit tests
```bash
# Run from the package that you want to start the tests from
pnpm test
```

### Blackbox tests

```bash
# Test against directus running with postgres
pnpm test

# Test against all databases
pnpm test:all

# Test against a specific database. The project option can be used multiple times to test against multiple different databases at the same time.
pnpm vitest --project sqlite
```

### Vitest options

Both unit and blackbox tests are running through [Vitest](https://vitest.dev) and thus support all options that vitest has to offer for customizing what tests to run.

```bash
# Run all tests that have "permission" in their filename.
pnpm test permissions

# Run all tests and watch for changes in the test files.
pnpm test -w
```

For more options, see [here](https://vitest.dev/guide/cli.html).

## Writing tests

The basic test structure goes as follows.

1. (optionally) Create a new folder for your tests
2. Create your test file, ending with `.test.ts`
3. You can start with this template:

```ts
import { createDirectus, rest, serverPing, staticToken } from '@directus/sdk';
import { useSnapshot } from '@utils/useSnapshot.js';
import { expect, test } from 'vitest';

import { port } from '@utils/constants.js';
import type { Schema } from './schema.js';

const api = createDirectus<Schema>(`http://localhost:${port}`)
  .with(rest())
  .with(staticToken('admin'));

const { collections } = await useSnapshot<Schema>(api);

test('ping', async () => {
	const result = await api.request(serverPing());

	expect(result).toBe('pong');
});
```

### Using a custom schema

Blackbox tests allow you to easily setup custom schemas for testing using the `useSnapshot` function. By default, the function uses the `snapshot.json` file that should be located on the same level as your test file.

In oder to create such a schema and types for said schema quickly, use the sandbox cli:

```bash
# Run this in the same folder as your tests
sandbox -s -x postgres
```

The `-x` option hereby exports the schema every 2s and the `-s` starts the directus instance using a preexisting `snapshot.json` so editing an exisitng snapshot is also quickly possible.

When creating collections, make that each collection ends with `_1234` as this is required to ensure that each collection will have a uniqe name in the blackbox tests. 





1. While writing tests, make sure that reruning a test doesn't cause conflicts. E.g. using `randomUUID()` to avoid user
   or permission collisions.

> The blackbox tests rely on the `@directus/sandbox` package for starting up the api so have a look there for more
> configuration options.

### Creating a custom schema

If a custom schema is required for your tests, make sure that each collection ends with `_1234`, that way a unique
collection name can be guaranteed.

A custom schema can be created by running the sandbox cli: `sandbox -x postgres` in the folder of your tests. This
automatically writes the `schema.d.ts` and `snapshot.json` into the current folder. If you quickly want to modify an
existing schema, use `sandbox -s -x postgres` to start up a sandbox with the schema preloaded.
